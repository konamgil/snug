// Snug - Room Rental Platform Database Schema
// 외국인 대상 한국 부동산 중개 + 운영 지원 플랫폼

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  GUEST         // 임차인 (외국인)
  HOST          // 메인 호스트 (임대인)
  CO_HOST       // 공동 호스트
  SNUG_OPERATOR // 스너그 운영자
  PARTNER       // 위탁협력 (외부업체)
}

enum PurposeOfStay {
  WORK
  STUDY
  BUSINESS
  FAMILY
  TOURISM
  MEDICAL
  OTHER
}

enum PartnerServiceType {
  CLEANING
  REPAIR
  MOVING
  OTHER
}

// ============================================
// EMAIL OTP (이메일 인증)
// ============================================

model EmailOtp {
  id          String   @id @default(cuid())

  email       String
  code        String   // 6자리 숫자
  type        OtpType  // SIGNUP, RESET_PASSWORD, FIND_ID

  verified    Boolean  @default(false)
  attempts    Int      @default(0)  // 시도 횟수 (최대 5회)

  expiresAt   DateTime // 5분 후 만료
  createdAt   DateTime @default(now())

  @@index([email, type])
  @@index([expiresAt])
  @@map("email_otps")
}

enum OtpType {
  SIGNUP
  RESET_PASSWORD
  FIND_ID
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  role          UserRole  @default(GUEST)

  // 기본 정보
  firstName     String?
  lastName      String?
  phone         String?
  countryCode   String?   @default("+82")
  avatarUrl     String?

  // 사용자 설정
  preferredCurrency String @default("KRW")   // KRW, USD, JPY, CNY, EUR
  preferredLanguage String @default("ko")    // ko, en, ja, zh, vi

  // Supabase Auth 연동
  supabaseId    String?   @unique

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations - 역할별 프로필
  guestProfile   GuestProfile?
  hostProfile    HostProfile?
  partnerProfile PartnerProfile?

  // Relations - 호스트 멤버십 (공동 호스트)
  ownedMemberships  HostMember[] @relation("HostOwner")    // 내가 호스트로서 초대한 멤버들
  memberMemberships HostMember[] @relation("MemberUser")   // 내가 멤버로 속한 호스트들

  // Relations - 숙소
  accommodationGroups AccommodationGroup[]
  accommodations      Accommodation[]

  // Relations - 계약 (게스트로서)
  contracts           Contract[]

  // Relations - 즐겨찾기
  favorites           Favorite[]

  // Relations - 최근 본 숙소
  recentlyViewed      RecentlyViewed[]

  // Relations - 운영 (파트너로서 배정받은 작업)
  assignedOperations  Operation[]

  @@map("users")
}

// 게스트 추가 정보
model GuestProfile {
  id              String         @id @default(cuid())
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  passportNumber  String?
  nationality     String?
  purposeOfStay   PurposeOfStay?
  aboutMe         String?        // 최대 100자

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("guest_profiles")
}

// 호스트 추가 정보
model HostProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessName    String?  // 사업자명
  businessNumber  String?  // 사업자번호
  bankName        String?
  bankAccount     String?
  accountHolder   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("host_profiles")
}

// 위탁협력 업체 추가 정보
model PartnerProfile {
  id              String             @id @default(cuid())
  userId          String             @unique
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyName     String?
  serviceType     PartnerServiceType @default(OTHER)
  description     String?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@map("partner_profiles")
}

// ============================================
// HOST MEMBER & PERMISSIONS (공동 호스트)
// ============================================

model HostMember {
  id          String   @id @default(cuid())

  hostId      String                           // 메인 호스트
  host        User     @relation("HostOwner", fields: [hostId], references: [id], onDelete: Cascade)

  memberId    String                           // 공동 호스트로 초대된 유저
  member      User     @relation("MemberUser", fields: [memberId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permissions HostMemberPermission[]

  @@unique([hostId, memberId])
  @@map("host_members")
}

enum PermissionType {
  CONTRACTS_VIEW
  CONTRACTS_MANAGE
  ACCOMMODATIONS_VIEW
  ACCOMMODATIONS_MANAGE
  SETTLEMENTS_VIEW
  SETTLEMENTS_MANAGE
  CHAT_ACCESS
  OPERATIONS_VIEW
  OPERATIONS_MANAGE
  USERS_MANAGE
}

model HostMemberPermission {
  id              String         @id @default(cuid())

  hostMemberId    String
  hostMember      HostMember     @relation(fields: [hostMemberId], references: [id], onDelete: Cascade)

  permission      PermissionType
  granted         Boolean        @default(false)

  createdAt       DateTime       @default(now())

  @@unique([hostMemberId, permission])
  @@map("host_member_permissions")
}

// ============================================
// ADDRESS MAPPING (주소 영문 매핑)
// ============================================

// 시/도, 시/군/구, 동 영문 매핑 테이블
model AddressMapping {
  id          String   @id @default(cuid())

  // 한글
  sido        String              // 서울특별시
  sigungu     String?             // 강남구 (시/도 레벨은 null)
  bname       String?             // 역삼동 (구 레벨은 null)

  // 영문
  sidoEn      String              // Seoul
  sigunguEn   String?             // Gangnam-gu
  bnameEn     String?             // Yeoksam-dong

  // 법정동코드 (공공데이터)
  code        String?  @unique    // 1168010100

  createdAt   DateTime @default(now())

  @@unique([sido, sigungu, bname])
  @@index([sido])
  @@index([sigungu])
  @@index([sidoEn])
  @@index([sigunguEn])
  @@map("address_mappings")
}

// 인기 지역명 별칭 테이블 (홍대, 이태원, 강남역 등)
model AddressAlias {
  id          String   @id @default(cuid())

  // 별칭 (검색어)
  alias       String              // 홍대, 강남역, 건대
  aliasEn     String?             // hongdae, gangnam station, konkuk

  // 매핑 대상 주소
  targetSido    String            // 서울특별시
  targetSigungu String?           // 마포구 (null이면 시/도 레벨)
  targetBname   String?           // 서교동 (null이면 구/군 레벨)

  // 매핑 대상 영문
  targetSidoEn    String          // Seoul
  targetSigunguEn String?         // Mapo-gu
  targetBnameEn   String?         // Seogyo-dong

  createdAt   DateTime @default(now())

  @@index([alias])
  @@index([aliasEn])
  @@map("address_aliases")
}

// ============================================
// ACCOMMODATION (숙소)
// ============================================

enum AccommodationType {
  HOUSE
  SHARE_ROOM
  SHARE_HOUSE
  APARTMENT
}

enum BuildingType {
  APARTMENT
  VILLA
  HOUSE
  OFFICETEL
}

enum UsageType {
  STAY        // 숙박
  SHORT_TERM  // 단기임대
}

enum GenderRule {
  MALE_ONLY
  FEMALE_ONLY
  PET_ALLOWED
}

enum AccommodationStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

// 숙소 그룹 (선택적)
model AccommodationGroup {
  id          String   @id @default(cuid())

  hostId      String
  host        User     @relation(fields: [hostId], references: [id], onDelete: Cascade)

  name        String   // "강남 셰어하우스"
  address     String?  // 공통 주소

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  accommodations Accommodation[]

  @@map("accommodation_groups")
}

// 개별 숙소 (방)
model Accommodation {
  id          String   @id @default(cuid())

  hostId      String
  host        User     @relation(fields: [hostId], references: [id], onDelete: Cascade)

  groupId     String?  // 그룹 없이도 가능
  group       AccommodationGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  // 기본 정보
  roomName          String              // "101호", "A룸"
  accommodationType AccommodationType   @default(HOUSE)
  buildingType      BuildingType?
  usageTypes        UsageType[]         // ['STAY', 'SHORT_TERM']
  minReservationDays Int                @default(1)

  // 위치 - 기본
  address           String              // 전체 주소 (표시용)
  addressDetail     String?             // 상세 주소 (호, 동)
  zipCode           String?             // 우편번호
  roadAddress       String?             // 도로명 주소

  // 위치 - 구조화 (다음 주소 API에서 파싱)
  sido              String?             // 시/도 (서울특별시)
  sigungu           String?             // 시/군/구 (강남구)
  bname             String?             // 법정동/리 (역삼동)
  buildingName      String?             // 건물명 (강남빌딩)

  // 위치 - 영문 (매핑 테이블에서 조회)
  sidoEn            String?             // Seoul
  sigunguEn         String?             // Gangnam-gu
  bnameEn           String?             // Yeoksam-dong

  // 위치 - 좌표 (카카오 API에서 조회)
  latitude          Float?
  longitude         Float?

  // 위치 - 교통
  nearestStation    String?
  walkingMinutes    Int?

  // 가격
  basePrice         Int                 // 기본 가격 (원)
  includesUtilities Boolean             @default(false)
  weekendPrice      Int?
  weekendDays       String[]            // ['fri', 'sat']
  managementFee     Int?
  cleaningFee       Int?
  extraPersonFee    Int?
  petFee            Int?

  // 공간 정보
  capacity          Int                 @default(1)
  genderRules       GenderRule[]
  sizeM2            Float?
  sizePyeong        Float?

  // 방 개수
  roomCount         Int                 @default(0)
  livingRoomCount   Int                 @default(0)
  kitchenCount      Int                 @default(0)
  bathroomCount     Int                 @default(0)
  terraceCount      Int                 @default(0)

  // 침대 개수 (JSON으로 저장)
  bedCounts         Json?               // {king: 1, queen: 0, single: 2, ...}

  // 텍스트 정보
  houseRules        String?
  introduction      String?

  // 상태
  status            AccommodationStatus @default(DRAFT)
  isOperating       Boolean             @default(false)
  openDate          DateTime?

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  photos            AccommodationPhoto[]
  facilities        AccommodationFacility[]
  amenities         AccommodationAmenity[]
  managers          AccommodationManager[]
  contracts         Contract[]
  favorites         Favorite[]
  recentlyViewed    RecentlyViewed[]
  operations        Operation[]

  @@index([hostId])
  @@index([status])
  @@index([latitude, longitude])
  @@map("accommodations")
}

// 숙소 사진
model AccommodationPhoto {
  id              String   @id @default(cuid())

  accommodationId String
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)

  category        String   // main, room, living_room, kitchen, bathroom
  url             String
  order           Int      @default(0)

  createdAt       DateTime @default(now())

  @@index([accommodationId, category])
  @@map("accommodation_photos")
}

// 숙소 시설
model AccommodationFacility {
  id              String   @id @default(cuid())

  accommodationId String
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)

  facilityCode    String   // digital_lock, wifi, tv, ...

  @@unique([accommodationId, facilityCode])
  @@map("accommodation_facilities")
}

// 숙소 어메니티
model AccommodationAmenity {
  id              String   @id @default(cuid())

  accommodationId String
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)

  amenityCode     String   // hair_dryer, towel, ...

  @@unique([accommodationId, amenityCode])
  @@map("accommodation_amenities")
}

// 숙소 담당자 (매니저)
model AccommodationManager {
  id              String   @id @default(cuid())

  accommodationId String
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)

  name            String
  phone           String
  additionalInfo  String?

  createdAt       DateTime @default(now())

  @@map("accommodation_managers")
}

// ============================================
// CONTRACT (계약)
// ============================================

enum ContractStatus {
  INQUIRY        // 문의
  PENDING        // 계약 신청
  CONFIRMED      // 예약 확정
  CHECKIN_SOON   // 체크인 예정
  STAYING        // 입주 중
  CHECKOUT_SOON  // 체크아웃 예정
  COMPLETED      // 퇴실 완료
  REJECTED       // 거절
  CANCELLED      // 취소/환불
}

model Contract {
  id              String         @id @default(cuid())

  // 관계
  guestId         String
  guest           User           @relation(fields: [guestId], references: [id])

  accommodationId String
  accommodation   Accommodation  @relation(fields: [accommodationId], references: [id])

  // 상태
  status          ContractStatus @default(INQUIRY)

  // 기간
  checkInDate     DateTime
  checkOutDate    DateTime
  nights          Int

  // 인원
  guestCount      Int            @default(1)

  // 가격 (계약 시점 스냅샷)
  basePrice       Int            // 숙박비
  cleaningFee     Int            @default(0)
  managementFee   Int            @default(0)
  serviceFee      Int            @default(0)  // Snug 수수료
  deposit         Int            @default(0)  // 보증금
  discount        Int            @default(0)  // 할인
  totalPrice      Int            // 총 금액

  // 게스트 정보 (계약서용)
  guestName       String
  guestGender     String?
  guestContact    String?
  guestEmail      String?
  passportNumber  String?
  residentNumber  String?        // 외국인등록번호

  // 부가 정보
  purpose         String?        // 거주 목적 (공부, 취업 등)
  detailRequest   String?        // 상세 요구사항

  // 결제자 정보 (본인 아닌 경우)
  payerName       String?        // "김여사 (모)"
  payerContact    String?
  payerBankAccount String?

  // 결제 주기
  paymentDay      Int?           // 매월 결제일 (1~31)

  // 메모 (호스트용)
  hostMemo        String?

  // 취소/거절
  cancelledAt     DateTime?
  cancelReason    String?
  rejectedAt      DateTime?
  rejectReason    String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  payments        Payment[]
  chatRoom        ChatRoom?
  operations      Operation[]

  @@index([guestId])
  @@index([accommodationId])
  @@index([status])
  @@index([checkInDate, checkOutDate])
  @@map("contracts")
}

// ============================================
// PAYMENT (결제)
// ============================================

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIAL_REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  APPLE_PAY
  ALI_PAY
  WECHAT_PAY
}

enum PaymentType {
  DEPOSIT      // 보증금
  MONTHLY_RENT // 월세
  CLEANING_FEE // 청소비
  UTILITY      // 공과금
  OTHER        // 기타
}

model Payment {
  id              String        @id @default(cuid())

  contractId      String
  contract        Contract      @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // 결제 정보
  type            PaymentType   @default(MONTHLY_RENT)
  amount          Int
  currency        String        @default("KRW")
  method          PaymentMethod?
  status          PaymentStatus @default(PENDING)

  // 결제 예정일 / 실제 결제일
  dueDate         DateTime?
  paidAt          DateTime?

  // 외부 결제 정보
  transactionId   String?       // PG사 거래 ID
  receiptUrl      String?

  // 환불 정보
  refundedAt      DateTime?
  refundAmount    Int?
  refundReason    String?

  // 메모
  description     String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([contractId])
  @@index([status])
  @@index([dueDate])
  @@map("payments")
}

// ============================================
// FAVORITE (즐겨찾기)
// ============================================

model Favorite {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  accommodationId String
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@unique([userId, accommodationId])
  @@map("favorites")
}

// ============================================
// RECENTLY VIEWED (최근 본 숙소)
// ============================================

model RecentlyViewed {
  id              String   @id @default(cuid())

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  accommodationId String
  accommodation   Accommodation @relation(fields: [accommodationId], references: [id], onDelete: Cascade)

  viewedAt        DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, accommodationId])
  @@index([userId, viewedAt(sort: Desc)])
  @@map("recently_viewed")
}

// ============================================
// OPERATION (운영/유지보수 요청)
// ============================================

enum OperationStatus {
  REQUESTED      // 요청됨
  ASSIGNED       // 업체 배정됨
  SCHEDULED      // 일정 확정
  IN_PROGRESS    // 진행 중
  COMPLETED      // 완료
  CANCELLED      // 취소
}

enum OperationType {
  CLEANING       // 청소
  REPAIR         // 수리
  INSPECTION     // 점검
  MOVE_IN        // 입주 준비
  MOVE_OUT       // 퇴실 정리
  OTHER          // 기타
}

model Operation {
  id              String          @id @default(cuid())

  // 숙소 연결
  accommodationId String
  accommodation   Accommodation   @relation(fields: [accommodationId], references: [id])

  // 계약 연결 (선택적 - 입주자 관련 요청인 경우)
  contractId      String?
  contract        Contract?       @relation(fields: [contractId], references: [id])

  // 요청 정보
  type            OperationType   @default(OTHER)
  status          OperationStatus @default(REQUESTED)
  title           String
  details         String?
  location        String?         // 구체적 위치 (ex: "101호 화장실")

  // 요청자 (게스트 또는 호스트)
  requesterId     String?
  requesterName   String?
  requesterContact String?

  // 희망 일정
  preferredDate   DateTime?
  preferredTime   String?         // "오전", "오후", "14:00-16:00"

  // 확정 일정
  scheduledDate   DateTime?
  scheduledTime   String?

  // 위탁업체 배정
  partnerId       String?
  partner         User?           @relation(fields: [partnerId], references: [id])

  // 완료 정보
  completedAt     DateTime?
  completionNote  String?

  // 비용
  estimatedCost   Int?
  actualCost      Int?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([accommodationId])
  @@index([status])
  @@index([partnerId])
  @@map("operations")
}

// ============================================
// CHAT (채팅)
// ============================================

model ChatRoom {
  id              String    @id @default(cuid())

  // 계약 연결 (선택적)
  contractId      String?   @unique
  contract        Contract? @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // 참여자 (JSON으로 저장 - 유연성)
  participantIds  String[]

  // 마지막 활동
  lastMessageAt   DateTime?
  lastMessage     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  messages        Message[]

  @@map("chat_rooms")
}

model Message {
  id              String    @id @default(cuid())

  chatRoomId      String
  chatRoom        ChatRoom  @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  senderId        String
  senderName      String?

  // 메시지 내용
  content         String
  type            String    @default("text")  // text, image, file, system

  // 읽음 상태 (JSON - 참여자별 읽음 시간)
  readBy          Json?     // {"userId1": "2024-01-01T00:00:00Z", ...}

  createdAt       DateTime  @default(now())

  @@index([chatRoomId, createdAt])
  @@map("messages")
}

// ============================================
// EXCHANGE RATES (환율)
// ============================================

model ExchangeRate {
  id            String    @id @default(cuid())

  // 통화 코드 (KRW 기준)
  currency      String    @unique  // USD, JPY, CNY, EUR

  // 환율 (1 KRW = ? 외화)
  rate          Decimal   @db.Decimal(20, 10)

  // 역환율 (1 외화 = ? KRW) - 조회 편의용
  inverseRate   Decimal   @db.Decimal(20, 4)

  // 마진 적용 환율 (사용자에게 표시)
  displayRate   Decimal   @db.Decimal(20, 10)

  // 마진 퍼센트
  marginPercent Decimal   @default(2.5) @db.Decimal(5, 2)

  // 데이터 소스
  source        String    @default("open.er-api.com")

  // 업데이트 시간
  fetchedAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("exchange_rates")
}

// ============================================
// FCM TOKENS (푸시 알림)
// ============================================

model FcmToken {
  id          String    @id @default(cuid())

  userId      String
  token       String    @unique  // FCM 토큰

  // 디바이스 정보
  deviceType  String?   // web, ios, android
  userAgent   String?   // 브라우저/앱 정보

  // 상태
  isActive    Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([token])
  @@map("fcm_tokens")
}
